"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("react");class d{constructor(t,e={}){var s;this.listeners=new Set,this.isTransitioning=!1,this.delayedTransitions=new Map,this.timers=new Map,this.send=i=>{if(this.isTransitioning){console.warn("State machine is currently transitioning. Event ignored:",i);return}const r=this.normalizeEvent(i);this.transition(r)},this.config=t,this.options=e,this.currentState=t.initial,this.context=t.context||{},(s=e.history)!=null&&s.enabled&&this.initializeHistory(),e.persistence&&this.loadPersistedState(),e.devTools&&typeof window<"u"&&this.setupDevTools()}getSnapshot(){const t=this.config.states[this.currentState];return{value:this.currentState,context:this.context,changed:!1,event:{type:"INIT"},meta:(t==null?void 0:t.meta)||{}}}subscribe(t){return this.listeners.add(t),t(this.getSnapshot()),()=>{this.listeners.delete(t)}}can(t){var e;const s=this.config.states[this.currentState],i=(e=s==null?void 0:s.on)==null?void 0:e[t];if(!i)return!1;const r=this.normalizeEvent(t);return this.canTransition(i,r)}getNextEvents(){const t=this.config.states[this.currentState];return t!=null&&t.on?Object.keys(t.on).filter(e=>this.can(e)):[]}withContext(t){const e={...this.config,context:{...this.context,...t}},s=new d(e,this.options);return s.currentState=this.currentState,s}initializeHistory(){var t;const e=((t=this.options.history)==null?void 0:t.maxSize)||50;this.history={states:[this.getSnapshot()],currentIndex:0,maxSize:e}}addToHistory(t){this.history&&(this.history.states=this.history.states.slice(0,this.history.currentIndex+1),this.history.states.push(t),this.history.currentIndex=this.history.states.length-1,this.history.states.length>this.history.maxSize&&(this.history.states.shift(),this.history.currentIndex--))}canUndo(){return this.history?this.history.currentIndex>0:!1}canRedo(){return this.history?this.history.currentIndex<this.history.states.length-1:!1}undo(){if(!this.canUndo()||!this.history)return!1;this.history.currentIndex--;const t=this.history.states[this.history.currentIndex];return this.currentState=t.value,this.context=t.context,this.notifyListeners({...t,changed:!0,event:{type:"UNDO"}}),!0}redo(){if(!this.canRedo()||!this.history)return!1;this.history.currentIndex++;const t=this.history.states[this.history.currentIndex];return this.currentState=t.value,this.context=t.context,this.notifyListeners({...t,changed:!0,event:{type:"REDO"}}),!0}getHistory(){return this.history}async loadPersistedState(){if(this.options.persistence)try{const t=await this.options.persistence.adapter.load(this.options.persistence.key);t&&(this.currentState=t.value,this.context=t.context)}catch(t){console.warn("Failed to load persisted state:",t)}}persistState(){if(!this.options.persistence)return;const t={value:this.currentState,context:this.context,timestamp:Date.now()};this.options.persistence.throttle?(this.persistenceThrottle&&clearTimeout(this.persistenceThrottle),this.persistenceThrottle=setTimeout(()=>{this.options.persistence.adapter.save(this.options.persistence.key,t)},this.options.persistence.throttle)):this.options.persistence.adapter.save(this.options.persistence.key,t)}startTimer(t,e){if(!this.options.timers){console.warn("Timers are not enabled. Set options.timers = true");return}this.clearTimer(t.id),t.interval?this.timers.set(t.id,setInterval(e,t.delay)):this.timers.set(t.id,setTimeout(()=>{e(),this.timers.delete(t.id)},t.delay))}clearTimer(t){const e=this.timers.get(t);e&&(clearTimeout(e),this.timers.delete(t))}sendDelayed(t,e){const s=`delayed_${Date.now()}_${Math.random()}`,i=this.normalizeEvent(t),r=setTimeout(()=>{this.send(i),this.delayedTransitions.delete(s)},e);return this.delayedTransitions.set(s,r),s}cancelDelayed(t){const e=this.delayedTransitions.get(t);return e?(clearTimeout(e),this.delayedTransitions.delete(t),!0):!1}matches(t){return Array.isArray(t)?t.includes(this.currentState):this.currentState===t}hasTag(t){var e,s;const i=this.config.states[this.currentState];return((s=(e=i==null?void 0:i.meta)==null?void 0:e.tags)==null?void 0:s.includes(t))||!1}destroy(){this.timers.forEach(t=>clearTimeout(t)),this.timers.clear(),this.delayedTransitions.forEach(t=>clearTimeout(t)),this.delayedTransitions.clear(),this.persistenceThrottle&&clearTimeout(this.persistenceThrottle),this.listeners.clear()}transition(t){var e;this.isTransitioning=!0;const s=this.config.states[this.currentState],i=(e=s==null?void 0:s.on)==null?void 0:e[t.type];if(!i||!this.canTransition(i,t)){this.isTransitioning=!1;return}const r=this.currentState,a=this.context;try{this.executeActions(s==null?void 0:s.exit,t),this.executeActions(i.actions,t),i.target&&(this.currentState=i.target);const c=this.config.states[this.currentState];this.executeActions(c==null?void 0:c.entry,t);const u={value:this.currentState,context:this.context,changed:r!==this.currentState||a!==this.context,event:t,meta:(c==null?void 0:c.meta)||{}};this.history&&u.changed&&this.addToHistory(u),u.changed&&this.persistState(),this.notifyListeners(u)}catch(c){console.error("Error during state transition:",c),this.currentState=r,this.context=a}finally{this.isTransitioning=!1}}canTransition(t,e){if(!t.guard)return!0;const s=this.resolveGuard(t.guard);return s?s(this.context,e):!0}executeActions(t,e){if(t)for(const s of t){const i=this.resolveAction(s);if(i){const r=i(this.context,e);r!==void 0&&(this.context=r)}}}resolveAction(t){var e;return typeof t=="function"?t:typeof t=="string"&&(e=this.options.actions)!=null&&e[t]?this.options.actions[t]:null}resolveGuard(t){var e;return typeof t=="function"?t:typeof t=="string"&&(e=this.options.guards)!=null&&e[t]?this.options.guards[t]:null}normalizeEvent(t){return typeof t=="object"&&t!==null&&"type"in t?t:{type:t}}notifyListeners(t){this.listeners.forEach(e=>{try{e(t)}catch(s){console.error("Error in state machine listener:",s)}})}setupDevTools(){if(typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION__){const t=window.__REDUX_DEVTOOLS_EXTENSION__.connect({name:"StateMachine"});this.subscribe(e=>{t.send(e.event,e)})}}}function y(n,t){const e=o.useRef();e.current||(e.current=new d(n,t));const[s,i]=o.useState(()=>e.current.getSnapshot());o.useEffect(()=>e.current.subscribe(i),[]);const r=o.useCallback(a=>{e.current.send(a)},[]);return[s,r,e.current]}function S(n){const t=o.useRef();t.current||(t.current=n());const[e,s]=o.useState(()=>t.current.getSnapshot());o.useEffect(()=>t.current.subscribe(s),[]);const i=o.useCallback(r=>{t.current.send(r)},[]);return[e,i,t.current]}function f(n){const[t,e]=o.useState(()=>n.getSnapshot());return o.useEffect(()=>n.subscribe(e),[n]),t}function g(n,t,e){const[s,i]=o.useState(()=>t(n.getSnapshot())),r=o.useRef(t),a=o.useRef(e);return r.current=t,a.current=e,o.useEffect(()=>n.subscribe(u=>{const h=r.current(u);i(l=>(a.current?a.current(l,h):Object.is(l,h))?l:h)}),[n]),s}function p(n){return o.useMemo(()=>n,[])}function v(n){return o.useMemo(()=>n,[])}function m(n,t){const e={...t,history:{enabled:!0,...t==null?void 0:t.history}},[s,i,r]=y(n,e),a=o.useMemo(()=>({undo:()=>r.undo(),redo:()=>r.redo(),canUndo:r.canUndo(),canRedo:r.canRedo(),history:r.getHistory()}),[r,s]);return[s,i,r,a]}function T(n,t,e){const s=o.useMemo(()=>({save:(r,a)=>{try{localStorage.setItem(r,JSON.stringify(a))}catch(c){console.warn("Failed to save to localStorage:",c)}},load:r=>{try{const a=localStorage.getItem(r);return a?JSON.parse(a):null}catch(a){return console.warn("Failed to load from localStorage:",a),null}},remove:r=>{try{localStorage.removeItem(r)}catch(a){console.warn("Failed to remove from localStorage:",a)}}}),[]),i={...e,persistence:{key:t,adapter:s,throttle:500}};return y(n,i)}function b(n){const t=o.useMemo(()=>({sendDelayed:(e,s)=>n.sendDelayed(e,s),cancelDelayed:e=>n.cancelDelayed(e),startTimer:(e,s)=>n.startTimer(e,s),clearTimer:e=>n.clearTimer(e)}),[n]);return o.useEffect(()=>()=>{n.destroy()},[n]),t}function x(n,t){const e=f(n);return o.useMemo(()=>{if(typeof t=="object"&&!Array.isArray(t)){const s={};for(const[i,r]of Object.entries(t))s[i]=n.matches(r);return s}else return n.matches(t)},[n,t,e.value])}function M(n,t={}){const{logTransitions:e=!0,logContext:s=!1}=t;return o.useEffect(()=>e?n.subscribe(r=>{r.changed&&(console.group(`ðŸ”„ State Transition: ${String(r.event.type)}`),console.log("Previous â†’ Current:",r.value),s&&console.log("Context:",r.context),console.log("Event:",r.event),console.log("Next Events:",n.getNextEvents()),console.groupEnd())}):void 0,[n,e,s]),{currentState:n.getSnapshot(),nextEvents:n.getNextEvents(),canTransition:i=>n.can(i),matches:i=>n.matches(i),hasTag:i=>n.hasTag(i)}}exports.useStateMachine=y;exports.useStateMachineActions=p;exports.useStateMachineDebug=M;exports.useStateMachineGuards=v;exports.useStateMachineMatches=x;exports.useStateMachineSelector=g;exports.useStateMachineService=S;exports.useStateMachineSubscription=f;exports.useStateMachineTimers=b;exports.useStateMachineWithHistory=m;exports.useStateMachineWithPersistence=T;
